<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phonecheck Device Lookup - WMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Toast Component
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const getToastStyles = () => {
                switch (type) {
                    case 'success': return 'bg-green-500 text-white';
                    case 'error': return 'bg-red-500 text-white';
                    case 'pending': return 'bg-yellow-500 text-white';
                    case 'warning': return 'bg-orange-500 text-white';
                    default: return 'bg-blue-500 text-white';
                }
            };

            const getIcon = () => {
                switch (type) {
                    case 'success': return '✓';
                    case 'error': return '✕';
                    case 'pending': return '⏳';
                    case 'warning': return '⚠';
                    default: return 'ℹ';
                }
            };

            return (
                <div className={`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${getToastStyles()} min-w-80`}>
                    <div className="flex items-center justify-between">
                        <div className="flex items-center">
                            <span className="mr-2 font-bold">{getIcon()}</span>
                            <span>{message}</span>
                        </div>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200 font-bold">×</button>
                    </div>
                </div>
            );
        };

        // PhonecheckLookup Component
        const PhonecheckLookup = ({ isOpen, onClose, onDataReceived, imei }) => {
            const [deviceData, setDeviceData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [lastRawData, setLastRawData] = useState(null);

            const PHONECHECK_CONFIG = {
                username: 'dncltechzoneinc',
                password: '@Ustvmos817',
                baseUrl: 'https://api.phonecheck.com'
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const validateIMEI = (imei) => {
                if (!imei) return false;
                const cleanIMEI = imei.replace(/\D/g, '');
                return cleanIMEI.length === 15;
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };

            const abstractData = (rawData) => {
                // Always use first object in array
                const raw = Array.isArray(rawData) ? rawData[0] : rawData;

                if (!raw) {
                    return null;
                }

                // Format date helper
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    if (isNaN(d)) return dateStr;
                    return d.toISOString().replace('T', ' ').substring(0, 16);
                }

                return {
                    // Basic Device Info
                    deviceName: ((raw.Model || '') + (raw.Memory ? ' ' + raw.Memory : '')).toUpperCase(),
                    brand: raw.Make || 'N/A', // Use Make from raw data
                    model: raw["Model#"] || 'N/A',
                    modelNumber: raw["Model#"] || 'N/A',
                    storage: raw.Memory || 'N/A',
                    color: raw.Color || 'N/A',
                    carrier: raw.Carrier || 'N/A',
                    carrierId: 'N/A',
                    type: 'N/A',
                                         imei: raw.IMEI || undefined,
                     serialNumber: raw.Serial || undefined,
                    condition: raw.Grade || 'N/A',

                    // Status Info
                    activationStatus: 'N/A',
                    activationDate: 'N/A',
                    blacklistStatus: 'N/A',
                    blacklistReason: 'N/A',
                    warrantyStatus: 'N/A',
                    warrantyExpiry: 'N/A',
                    contractStatus: 'N/A',
                    contractEndDate: 'N/A',

                    // Technical Details
                    networkType: 'N/A',
                    simLock: 'N/A',
                    esnStatus: 'N/A',
                    meidStatus: 'N/A',
                    iccid: 'N/A',
                    mdn: 'N/A',

                    // Working Status
                    working: raw.Working || 'N/A',
                    batteryHealth: raw.BatteryHealthPercentage || 'N/A',
                    batteryCycle: raw.BatteryCycle || 'N/A',
                    mdm: raw.MDM || 'N/A',
                    notes: raw.Notes || 'N/A',
                    failed: raw.Failed || 'N/A',
                    testerName: raw.TesterName || 'N/A',
                    repairNotes: raw.Custom1 || 'N/A',

                    // Additional Info
                    firstReceived: formatDate(raw.DeviceCreatedDate),
                    lastUpdate: formatDate(raw.DeviceUpdatedDate),
                    checkDate: formatDate(new Date()),
                    source: 'Phonecheck API'
                };
            };

            const performLookup = async () => {
                setLoading(true);
                setError(null);
                setDeviceData(null);
                setLastRawData(null);

                try {
                    // Step 1: Get authentication token
                    const authResponse = await fetch(`${PHONECHECK_CONFIG.baseUrl}/v2/auth/master/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: PHONECHECK_CONFIG.username,
                            password: PHONECHECK_CONFIG.password
                        })
                    });

                    if (!authResponse.ok) {
                        const errorText = await authResponse.text();
                        throw new Error(`Authentication failed: ${errorText}`);
                    }

                    const authData = await authResponse.json();
                    const token = authData.token;

                    if (!token) {
                        throw new Error('No authentication token received');
                    }

                    // Step 2: Perform device lookup
                    const lookupResponse = await fetch(`${PHONECHECK_CONFIG.baseUrl}/v2/master/imei/device-info-legacy/${imei}?detailed=true`, {
                        method: 'GET',
                        headers: {
                            'token_master': token
                        }
                    });

                    if (!lookupResponse.ok) {
                        const errorText = await lookupResponse.text();
                        throw new Error(`Device lookup failed: ${errorText}`);
                    }

                    const rawData = await lookupResponse.json();
                    setLastRawData(rawData);

                                         const abstractedData = abstractData(rawData);
                     if (abstractedData) {
                         setDeviceData(abstractedData);
                         onDataReceived(abstractedData, rawData);
                     } else {
                        throw new Error('Failed to process device data');
                    }

                } catch (error) {
                    console.error('Phonecheck lookup error:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (isOpen && imei) {
                    performLookup();
                }
            }, [isOpen, imei]);

            if (!isOpen) return null;

            return (
                <div className="bg-white rounded-lg shadow-lg p-8 my-6">
                    {loading && (
                        <div className="text-center py-12">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                            <h3 className="text-xl font-semibold text-gray-900 mb-2">Fetching Device Information</h3>
                            <p className="text-gray-600">Looking up IMEI: {imei}</p>
                        </div>
                    )}

                    {error && (
                        <div className="text-center py-8">
                            <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-4">
                                <h3 className="text-lg font-semibold text-red-800 mb-2">Error</h3>
                                <p className="text-red-600 mb-4">{error}</p>
                                <div className="flex justify-center space-x-3">
                                    <button 
                                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                                        onClick={performLookup}
                                    >
                                        Retry
                                    </button>
                                    <button 
                                        className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors"
                                        onClick={onClose}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {deviceData && (
                        <div>
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="text-2xl font-bold text-gray-900">Device Information Retrieved</h3>
                                <div className="flex space-x-3">
                                    <button 
                                        className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors"
                                        onClick={onClose}
                                    >
                                        Close
                                    </button>
                                                                         <button 
                                         className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                         onClick={() => onDataReceived(deviceData, lastRawData)}
                                     >
                                         Use This Data
                                     </button>
                                </div>
                            </div>

                            {/* Device Information Grid */}
                            <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                <h4 className="text-lg font-semibold text-gray-900 mb-4">Device Details</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Device Name</label>
                                        <p className="text-gray-900 font-medium">{deviceData.deviceName}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Brand</label>
                                        <p className="text-gray-900 font-medium">{deviceData.brand}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Model</label>
                                        <p className="text-gray-900 font-medium">{deviceData.model}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Storage</label>
                                        <p className="text-gray-900 font-medium">{deviceData.storage}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Color</label>
                                        <p className="text-gray-900 font-medium">{deviceData.color}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Carrier</label>
                                        <p className="text-gray-900 font-medium">{deviceData.carrier}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">IMEI</label>
                                        <p className="text-gray-900 font-medium">{deviceData.imei}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Serial Number</label>
                                        <p className="text-gray-900 font-medium">{deviceData.serialNumber}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Condition</label>
                                        <p className="text-gray-900 font-medium">{deviceData.condition}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Status Information */}
                            <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                <h4 className="text-lg font-semibold text-gray-900 mb-4">Status Information</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Working Status</label>
                                        <div className="mt-1">
                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                deviceData.working === 'YES' ? 'bg-green-100 text-green-800' :
                                                deviceData.working === 'NO' ? 'bg-red-100 text-red-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }`}>
                                                {deviceData.working}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Failed Status</label>
                                        <div className="mt-1">
                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                deviceData.failed ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                                            }`}>
                                                {deviceData.failed ? 'FAILED' : 'PASS'}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Battery Health</label>
                                        <p className="text-gray-900 font-medium">{deviceData.batteryHealth}%</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Battery Cycles</label>
                                        <p className="text-gray-900 font-medium">{deviceData.batteryCycle}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">MDM Status</label>
                                        <p className="text-gray-900 font-medium">{deviceData.mdm}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Tester Name</label>
                                        <p className="text-gray-900 font-medium">{deviceData.testerName}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Notes and Defects Section */}
                            {(deviceData.notes || deviceData.failed || deviceData.repairNotes) && (
                                <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                    <h4 className="text-lg font-semibold text-gray-900 mb-4">Notes & Defects</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {deviceData.notes && (
                                            <div className="bg-white p-4 rounded-lg border">
                                                <label className="text-sm font-medium text-gray-500">Notes</label>
                                                <p className="text-gray-900 font-medium">{deviceData.notes}</p>
                                            </div>
                                        )}
                                        {deviceData.failed && (
                                            <div className="bg-white p-4 rounded-lg border">
                                                <label className="text-sm font-medium text-gray-500">Defects</label>
                                                <p className="text-red-600 font-semibold">{deviceData.failed}</p>
                                            </div>
                                        )}
                                        {deviceData.repairNotes && (
                                            <div className="bg-white p-4 rounded-lg border">
                                                <label className="text-sm font-medium text-gray-500">Repair Notes</label>
                                                <p className="text-gray-900 font-medium">{deviceData.repairNotes}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Additional Information */}
                            <div className="bg-gray-50 rounded-lg p-6">
                                <h4 className="text-lg font-semibold text-gray-900 mb-4">Additional Information</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">First Received</label>
                                        <p className="text-gray-900 font-medium">{deviceData.firstReceived}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg border">
                                        <label className="text-sm font-medium text-gray-500">Last Updated</label>
                                        <p className="text-gray-900 font-medium">{deviceData.lastUpdate}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // IMEI Input Form Component
        const IMEIInputForm = () => {
            const [imei, setImei] = useState('');
            const [showPhonecheck, setShowPhonecheck] = useState(false);
            const [phonecheckData, setPhonecheckData] = useState(null);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [pendingInventoryData, setPendingInventoryData] = useState(null);
            const [locations, setLocations] = useState([]);
            const [selectedLocation, setSelectedLocation] = useState('');
                         const [toast, setToast] = useState(null);
             const [showFullPackage, setShowFullPackage] = useState(false);
             const [showRawData, setShowRawData] = useState(false);
             const [lastRawData, setLastRawData] = useState(null);

            useEffect(() => {
                fetchLocations();
            }, []);

            const fetchLocations = async () => {
                try {
                    const response = await fetch('/api/admin/locations');
                    if (response.ok) {
                        const data = await response.json();
                        setLocations(data);
                        if (data.length > 0) {
                            setSelectedLocation(data[0].name);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching locations:', error);
                    setToast({ message: 'Failed to fetch locations', type: 'error' });
                }
            };

            const handleIMEIChange = (e) => {
                const value = e.target.value;
                setImei(value);
                
                // Auto-trigger Phonecheck when IMEI is 15 digits
                if (value.replace(/\D/g, '').length === 15) {
                    setShowPhonecheck(true);
                } else {
                    setShowPhonecheck(false);
                    setPhonecheckData(null);
                }
            };

                         const handlePhonecheckDataReceived = (data, rawData) => {
                 console.log('Phonecheck data received:', data);
                 setPhonecheckData(data);
                 setLastRawData(rawData);
                 setShowPhonecheck(false);
                 setShowFullPackage(false);
                 setShowRawData(false);
                 
                                   // Pre-fill the form with Phonecheck data
                  setPendingInventoryData({
                      name: data.deviceName,
                      brand: data.brand || 'Unknown',
                      model: data.model,
                      storage: data.storage || undefined,
                      color: data.color || undefined,
                      carrier: data.carrier || undefined,
                      type: 'PHONE', // Use uppercase for consistency
                      imei: data.imei !== 'N/A' ? data.imei : imei, // Use Phonecheck IMEI or fallback to user input
                      serialNumber: data.serialNumber !== 'N/A' ? data.serialNumber : undefined,
                      condition: data.condition || 'UNKNOWN',
                                 // Add PhoneCheck specific fields
           batteryHealth: data.batteryHealth || undefined,
           screenCondition: data.screenCondition || undefined,
           bodyCondition: data.bodyCondition || undefined,
           working: data.working || data.workingStatus || (data.failed === false ? 'YES' : data.failed === true ? 'NO' : 'PENDING'),
           defects: data.defects || undefined,
           notes: data.notes || undefined,
           custom1: data.custom1 || undefined,
           testResults: lastRawData || data, // Include full PhoneCheck data
                      quantity: 1,
                      location: selectedLocation // Location already includes DNCL- prefix from API
                  });
             };

                         const handleSubmit = (e) => {
                 e.preventDefault();
                 
                 console.log('Submit button clicked');
                 console.log('Phonecheck data:', phonecheckData);
                 console.log('Pending inventory data:', pendingInventoryData);
                 
                 if (!phonecheckData) {
                     setToast({ message: 'Please wait for Phonecheck lookup to complete', type: 'error' });
                     return;
                 }

                                   if (!pendingInventoryData) {
                      setToast({ message: 'No inventory data available', type: 'error' });
                      return;
                  }

                  // Validate that we have IMEI
                  if (!pendingInventoryData.imei) {
                      setToast({ message: 'IMEI is required', type: 'error' });
                      return;
                  }

                 setShowConfirmation(true);
             };

                         const handleConfirmedSubmit = async () => {
                 try {
                     console.log('Sending inventory data:', pendingInventoryData);
                     console.log('Data validation check:', {
                         hasImei: !!pendingInventoryData.imei,
                         hasSerialNumber: !!pendingInventoryData.serialNumber,
                         imeiValue: pendingInventoryData.imei,
                         serialNumberValue: pendingInventoryData.serialNumber
                     });
                     
                     const response = await fetch('/api/admin/inventory-push', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify(pendingInventoryData)
                     });

                                         if (response.ok) {
                         setToast({ message: 'Inventory added successfully!', type: 'success' });
                         setImei('');
                         setPhonecheckData(null);
                         setPendingInventoryData(null);
                         setLastRawData(null);
                         setShowConfirmation(false);
                         setShowFullPackage(false);
                         setShowRawData(false);
                                          } else {
                         const errorData = await response.json();
                         console.error('API Error Response:', errorData);
                         
                                                   // Show more specific error messages
                          let errorMessage = 'Failed to add inventory';
                          if (errorData.error) {
                              if (errorData.error.includes('IMEI is required')) {
                                  errorMessage = 'IMEI is required';
                              } else if (errorData.error.includes('Location')) {
                                  errorMessage = 'Invalid location selected';
                              } else {
                                  errorMessage = errorData.error;
                              }
                          }
                         
                         setToast({ message: errorMessage, type: 'error' });
                     }
                 } catch (error) {
                     console.error('Error adding inventory:', error);
                     setToast({ message: 'Failed to add inventory', type: 'error' });
                 }
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">Add Device with Phonecheck</h2>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label htmlFor="imei" className="block text-sm font-medium text-gray-700 mb-2">
                                    IMEI Number
                                </label>
                                <input
                                    type="text"
                                    id="imei"
                                    value={imei}
                                    onChange={handleIMEIChange}
                                    placeholder="Enter IMEI number (15 digits)"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                                <p className="mt-1 text-sm text-gray-500">
                                    Phonecheck lookup will automatically start when you enter a valid 15-digit IMEI
                                </p>
                            </div>

                            <div>
                                <label htmlFor="location" className="block text-sm font-medium text-gray-700 mb-2">
                                    Location
                                </label>
                                <select
                                    id="location"
                                    value={selectedLocation}
                                    onChange={(e) => setSelectedLocation(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    required
                                >
                                    {locations.map(location => (
                                        <option key={location.id} value={location.name}>
                                            {location.name}
                                        </option>
                                    ))}
                                </select>
                            </div>

                                                         <div className="flex space-x-3">
                                 <button
                                     type="submit"
                                     className="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                     disabled={!phonecheckData}
                                 >
                                     Add to Inventory
                                 </button>
                                 <button
                                     type="button"
                                     onClick={handleConfirmedSubmit}
                                     className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                     disabled={!phonecheckData}
                                 >
                                     Add Directly (Skip Confirmation)
                                 </button>
                             </div>
                        </form>

                        {/* Phonecheck Lookup Area */}
                        <PhonecheckLookup
                            isOpen={showPhonecheck}
                            onClose={() => setShowPhonecheck(false)}
                            onDataReceived={handlePhonecheckDataReceived}
                            imei={imei}
                        />

                        {/* Phonecheck Data Ready Display */}
                        {phonecheckData && !showPhonecheck && (
                            <div className="mt-8 bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6 shadow-lg">
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                        <h3 className="text-xl font-bold text-green-900">Phonecheck Data Ready</h3>
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={() => setShowFullPackage(!showFullPackage)}
                                            className={`px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 ${
                                                showFullPackage 
                                                    ? 'bg-blue-100 text-blue-700 border border-blue-300 hover:bg-blue-200' 
                                                    : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg'
                                            }`}
                                        >
                                            {showFullPackage ? 'Hide Full Package' : 'Show Full Package'}
                                        </button>
                                        <button
                                            onClick={() => setShowRawData(!showRawData)}
                                            className={`px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 ${
                                                showRawData 
                                                    ? 'bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200' 
                                                    : 'bg-gray-600 text-white hover:bg-gray-700 shadow-md hover:shadow-lg'
                                            }`}
                                        >
                                            {showRawData ? 'Hide Raw Data' : 'Show Raw Data'}
                                        </button>
                                    </div>
                                </div>
                                
                                                                                                  {/* Unified Data Display - Connected Tables */}
                                 <div className="bg-white rounded-lg border shadow-sm overflow-hidden">
                                     {/* Basic Data Section */}
                                     <div className="border-b border-gray-200">
                                         <div className="grid grid-cols-6 gap-4 p-4 bg-gradient-to-r from-gray-50 to-gray-100">
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">DEVICE NAME</div>
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">MODEL NUMBER</div>
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">IMEI</div>
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">WORKING STATUS</div>
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">LAST UPDATE</div>
                                             <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">TESTER NAME</div>
                                         </div>
                                         <div className="grid grid-cols-6 gap-4 p-4 hover:bg-gray-50 transition-colors">
                                             <div className="text-gray-900 font-semibold text-sm text-center break-words leading-relaxed">{phonecheckData.deviceName}</div>
                                             <div className="text-gray-700 text-sm font-mono text-center break-all leading-relaxed">{phonecheckData.modelNumber}</div>
                                             <div className="text-gray-700 text-sm font-mono text-center break-all leading-relaxed">{phonecheckData.imei}</div>
                                             <div className="flex justify-center items-center">
                                                 <span className={`inline-flex px-3 py-1 text-xs font-bold rounded-full shadow-sm ${
                                                     phonecheckData.working === 'YES' ? 'bg-green-100 text-green-800 border border-green-200' :
                                                     phonecheckData.working === 'NO' ? 'bg-red-100 text-red-800 border border-red-200' :
                                                     'bg-yellow-100 text-yellow-800 border border-yellow-200'
                                                 }`}>
                                                     {phonecheckData.working === 'YES' ? 'PASS' : 
                                                      phonecheckData.working === 'NO' ? 'FAILED' : 
                                                      phonecheckData.working}
                                                 </span>
                                             </div>
                                             <div className="text-gray-700 text-sm text-center leading-relaxed">
                                                 <div className="font-medium">{phonecheckData.lastUpdate.split(' ')[0]}</div>
                                                 <div className="text-gray-500 text-xs">{phonecheckData.lastUpdate.split(' ')[1]}</div>
                                             </div>
                                             <div className="text-gray-700 text-sm font-medium text-center break-words leading-relaxed">{phonecheckData.testerName}</div>
                                         </div>
                                     </div>

                                     {/* Notes, Defects, and Repair Notes Section - Connected */}
                                     {(phonecheckData.notes || phonecheckData.failed || phonecheckData.repairNotes) && (
                                         <div className="border-t border-gray-200">
                                             <div className="grid grid-cols-3 gap-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50">
                                                 <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">NOTES</div>
                                                 <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">DEFECTS</div>
                                                 <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">REPAIR NOTES</div>
                                             </div>
                                             <div className="grid grid-cols-3 gap-4 p-4 hover:bg-gray-50 transition-colors">
                                                 <div className="text-gray-700 text-sm text-center min-h-[2rem] flex items-center justify-center">
                                                     {phonecheckData.notes ? (
                                                         <span className="inline-flex items-center px-3 py-2 rounded-full text-xs font-medium bg-blue-100 text-blue-800 break-words max-w-full">
                                                             {phonecheckData.notes}
                                                         </span>
                                                     ) : (
                                                         <span className="text-gray-400 text-sm italic">N/A</span>
                                                     )}
                                                 </div>
                                                 <div className="text-gray-700 text-sm text-center min-h-[2rem] flex items-center justify-center">
                                                     {phonecheckData.failed ? (
                                                         <span className="inline-flex items-center px-3 py-2 rounded-full text-xs font-medium bg-red-100 text-red-800 break-words max-w-full">
                                                             {phonecheckData.failed}
                                                         </span>
                                                     ) : (
                                                         <span className="text-gray-400 text-sm italic">N/A</span>
                                                     )}
                                                 </div>
                                                 <div className="text-gray-700 text-sm text-center min-h-[2rem] flex items-center justify-center">
                                                     {phonecheckData.repairNotes ? (
                                                         <span className="inline-flex items-center px-3 py-2 rounded-full text-xs font-medium bg-purple-100 text-purple-800 break-words max-w-full">
                                                             {phonecheckData.repairNotes}
                                                         </span>
                                                     ) : (
                                                         <span className="text-gray-400 text-sm italic">N/A</span>
                                                     )}
                                                 </div>
                                             </div>
                                         </div>
                                     )}
                                 </div>

                                {/* Full Package Data Display */}
                                {showFullPackage && (
                                    <div className="mt-4 bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 shadow-md">
                                        <div className="flex items-center space-x-2 mb-4">
                                            <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                            <h4 className="text-lg font-bold text-blue-900">Full Data Package (Going to Database)</h4>
                                        </div>
                                                                                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Device Name</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.deviceName}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Brand</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.brand}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Model</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.model}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Model Number</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-all leading-relaxed font-mono">{phonecheckData.modelNumber}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Storage</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.storage}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Color</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.color}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Carrier</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.carrier}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Type</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.type}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">IMEI</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-all leading-relaxed font-mono">{phonecheckData.imei}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Serial Number</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-all leading-relaxed font-mono">{phonecheckData.serialNumber}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Condition</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.condition}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Working Status</label>
                                                 <div className="flex justify-center mt-2">
                                                     <span className={`inline-flex px-3 py-1 text-xs font-bold rounded-full shadow-sm ${
                                                         phonecheckData.working === 'YES' ? 'bg-green-100 text-green-800 border border-green-200' :
                                                         phonecheckData.working === 'NO' ? 'bg-red-100 text-red-800 border border-red-200' :
                                                         'bg-yellow-100 text-yellow-800 border border-yellow-200'
                                                     }`}>
                                                         {phonecheckData.working === 'YES' ? 'PASS' : 
                                                          phonecheckData.working === 'NO' ? 'FAILED' : 
                                                          phonecheckData.working}
                                                     </span>
                                                 </div>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Battery Health</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center leading-relaxed">{phonecheckData.batteryHealth}%</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Battery Cycles</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center leading-relaxed">{phonecheckData.batteryCycle}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">MDM Status</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.mdm}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Failed Status</label>
                                                 <div className="flex justify-center mt-2">
                                                     <span className={`inline-flex px-3 py-1 text-xs font-bold rounded-full shadow-sm ${
                                                         phonecheckData.failed ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'
                                                     }`}>
                                                         {phonecheckData.failed ? 'FAILED' : 'PASS'}
                                                     </span>
                                                 </div>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Tester Name</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.testerName}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">First Received</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.firstReceived}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Last Update</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.lastUpdate}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Check Date</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.checkDate}</p>
                                             </div>
                                             <div className="bg-white p-4 rounded-lg border shadow-sm">
                                                 <label className="text-xs font-bold text-gray-600 uppercase tracking-wide text-center block mb-2">Source</label>
                                                 <p className="text-sm text-gray-900 font-medium text-center break-words leading-relaxed">{phonecheckData.source}</p>
                                             </div>
                                         </div>
                                        
                                                                                                                           {/* Notes and Defects Section - Row Layout */}
                                          {(phonecheckData.notes || phonecheckData.failed || phonecheckData.repairNotes) && (
                                              <div className="mt-6 bg-gradient-to-br from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-6 shadow-md">
                                                  <div className="flex items-center space-x-2 mb-4">
                                                      <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                                      <h5 className="text-lg font-bold text-yellow-900">Notes & Defects</h5>
                                                  </div>
                                                  <div className="bg-white rounded-lg border shadow-sm">
                                                      <div className="grid grid-cols-3 gap-4 p-4 border-b bg-gradient-to-r from-gray-50 to-gray-100">
                                                          <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">NOTES</div>
                                                          <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">DEFECTS</div>
                                                          <div className="font-bold text-gray-800 text-xs uppercase tracking-wider text-center">REPAIR NOTES</div>
                                                      </div>
                                                      <div className="grid grid-cols-3 gap-4 p-4">
                                                          <div className="text-sm text-gray-900 text-center break-words leading-relaxed min-h-[2rem] flex items-center justify-center">
                                                              {phonecheckData.notes || <span className="text-gray-400 italic">N/A</span>}
                                                          </div>
                                                          <div className="text-sm text-red-600 font-semibold text-center break-words leading-relaxed min-h-[2rem] flex items-center justify-center">
                                                              {phonecheckData.failed || <span className="text-gray-400 italic">N/A</span>}
                                                          </div>
                                                          <div className="text-sm text-gray-900 text-center break-words leading-relaxed min-h-[2rem] flex items-center justify-center">
                                                              {phonecheckData.repairNotes || <span className="text-gray-400 italic">N/A</span>}
                                                          </div>
                                                      </div>
                                                  </div>
                                              </div>
                                          )}
                                    </div>
                                )}

                                {/* Raw Data Display */}
                                {showRawData && lastRawData && (
                                    <div className="mt-4 bg-gradient-to-br from-gray-50 to-slate-50 border border-gray-200 rounded-xl p-6 shadow-md">
                                        <div className="flex items-center space-x-2 mb-4">
                                            <div className="w-2 h-2 bg-gray-500 rounded-full"></div>
                                            <h4 className="text-lg font-bold text-gray-900">Raw Phonecheck API Response</h4>
                                        </div>
                                                                                 <div className="bg-white p-4 rounded-lg border shadow-sm overflow-auto max-h-80">
                                             <pre className="text-xs text-gray-800 whitespace-pre-wrap font-mono leading-relaxed">{JSON.stringify(lastRawData, null, 2)}</pre>
                                         </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Confirmation Modal */}
                    {showConfirmation && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                            <div className="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                                <div className="mt-3 text-center">
                                    <h3 className="text-lg font-medium text-gray-900 mb-4">Confirm Inventory Addition</h3>
                                    <p className="text-sm text-gray-500 mb-6">Are you sure you want to add this device to inventory?</p>
                                    <div className="flex justify-center space-x-3">
                                        <button 
                                            className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors"
                                            onClick={() => setShowConfirmation(false)}
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                            onClick={handleConfirmedSubmit}
                                        >
                                            Confirm Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && (
                        <Toast
                            message={toast.message}
                            type={toast.type}
                            onClose={() => setToast(null)}
                        />
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-6">
                                <div className="flex items-center">
                                    <h1 className="text-2xl font-bold text-gray-900">WMS - Phonecheck Device Lookup</h1>
                                </div>
                                                                 <div className="flex space-x-3">
                                     <a
                                         href="/phonecheck.html"
                                         className="px-4 py-2 bg-blue-100 text-blue-700 rounded-md font-medium"
                                     >
                                         Phonecheck
                                     </a>
                                     <a
                                         href="/bulk-add.html"
                                         className="px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors"
                                     >
                                         Bulk Add
                                     </a>
                                     <a
                                         href="/inventory-manager.html"
                                         className="px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors"
                                     >
                                         Inventory Manager
                                     </a>
                                 </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <IMEIInputForm />
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
